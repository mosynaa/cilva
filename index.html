<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Catalogo Ordini</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background-color: #f2f2f2; }
    input[type="text"], input[type="number"] { width: 80px; }
    button { padding: 8px 12px; margin: 10px 0; }

    /* Modal */
    .modal { display: none; position: fixed; z-index: 999; left: 0; top: 0; width: 100%; height: 100%; 
             overflow: auto; background-color: rgba(0,0,0,0.4); }
    .modal-content { background-color: #fff; margin: 10% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 500px; }
    .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
    .close:hover { color: #000; }
  </style>
</head>
<body>

<h1>Catalogo Ordini</h1>

<input type="text" id="search" placeholder="Cerca...">
<button id="openCart">Apri Carrello ðŸ›’</button>

<table id="catalogo">
  <thead>
    <tr>
      <th>Codice</th>
      <th>Descrizione</th>
      <th>Categoria</th>
      <th>Prezzo</th>
      <th>QuantitÃ </th>
      <th>P.P.</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<!-- Modal Carrello -->
<div id="cartModal" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <h2>Carrello</h2>
    <ul id="cart-list"></ul>
  </div>
</div>

<script>
let catalogo = [];
let cart = {};

fetch('https://raw.githubusercontent.com/mosynaa/ordinecil/main/catalogo.csv')
  .then(response => response.text())
  .then(text => {
    const rows = text.split('\n').slice(1); // Salta intestazione
    catalogo = rows.map(row => {
      const [codice, descrizione, categoria, prezzo] = row.split(',');
      return { codice, descrizione, categoria, prezzo: prezzo?.trim() || '' };
    });
    renderCatalogo(catalogo);
  });

function renderCatalogo(data) {
  const tbody = document.querySelector('#catalogo tbody');
  tbody.innerHTML = '';
  data.forEach((item, index) => {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${item.codice}</td>
      <td>${item.descrizione}</td>
      <td>${item.categoria}</td>
      <td>${item.prezzo || 'P.P.'}</td>
      <td><input type="number" min="0" data-index="${index}" class="qty" placeholder="CT"></td>
      <td><input type="number" min="0" data-index="${index}" class="pp" placeholder="P.P."></td>
    `;
    tbody.appendChild(row);
  });
}

document.querySelector('#catalogo').addEventListener('input', e => {
  if (e.target.classList.contains('qty') || e.target.classList.contains('pp')) {
    const index = e.target.dataset.index;
    const field = e.target.classList.contains('qty') ? 'quantitÃ ' : 'prezzoPagato';
    if (!cart[index]) cart[index] = { ...catalogo[index], quantitÃ : '', prezzoPagato: '' };
    cart[index][field] = e.target.value;
  }
});

function aggiornaCarrello() {
  const cartList = document.getElementById('cart-list');
  cartList.innerHTML = '';
  let totArticoli = 0;
  let totPrezzo = 0;
  Object.values(cart).forEach(item => {
    if (item.quantitÃ  || item.prezzoPagato) {
      const qta = item.quantitÃ  || '-';
      const pp = item.prezzoPagato || '-';
      const li = document.createElement('li');
      li.textContent = `${item.codice} - ${item.descrizione} | Q.tÃ : ${qta} | P.P.: ${pp}`;
      cartList.appendChild(li);
    }
  });
}

document.getElementById('openCart').addEventListener('click', () => {
  aggiornaCarrello();
  document.getElementById('cartModal').style.display = 'block';
});

document.querySelector('.close').addEventListener('click', () => {
  document.getElementById('cartModal').style.display = 'none';
});

window.addEventListener('click', e => {
  if (e.target === document.getElementById('cartModal')) {
    document.getElementById('cartModal').style.display = 'none';
  }
});

document.getElementById('search').addEventListener('input', e => {
  const keyword = e.target.value.toLowerCase();
  const filtered = catalogo.filter(item =>
    item.codice.toLowerCase().includes(keyword) ||
    item.descrizione.toLowerCase().includes(keyword) ||
    item.categoria.toLowerCase().includes(keyword)
  );
  renderCatalogo(filtered);
  // Ripristina i valori inseriti
  setTimeout(() => {
    Object.entries(cart).forEach(([index, item]) => {
      const qtyInput = document.querySelector(`input.qty[data-index="${index}"]`);
      const ppInput = document.querySelector(`input.pp[data-index="${index}"]`);
      if (qtyInput) qtyInput.value = item.quantitÃ  || '';
      if (ppInput) ppInput.value = item.prezzoPagato || '';
    });
  }, 100);
});
</script>

</body>
</html>
